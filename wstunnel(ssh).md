

## راهنمای راه‌اندازی تونل امن با wstunnel

این داکیومنت به شما کمک می‌کنه تا یک تونل امن بین دو سرور (یک سرور **خارجی** و یک سرور در **ایران**) با استفاده از `wstunnel` و `SSH` ایجاد کنید.

### 🔑 تولید کلید SSH (در سرور خارجی)

ابتدا در سرور خارجی خود یک جفت کلید SSH جدید تولید کنید. این کلید برای احراز هویت SSH بین دو سرور استفاده میشه:

```bash
ssh-keygen -t ecdsa -f ~/.ssh/id_ecdsa -q -N "" && printf "\n\nSSH Public Key:\n\033[32m$(cat ~/.ssh/id_ecdsa.pub | awk '{print $1, $2}')\n\n\033[0m"
```

بعد از اجرای این دستور، **کلید عمومی SSH** شما نمایش داده میشه. اون رو کپی کنید.

### 📜 افزودن کلید عمومی به سرور ایران (در سرور ایران)

حالا به سرور ایران خودتون وصل بشید و کلید عمومی کپی شده رو به فایل `~/.ssh/authorized_keys` اضافه کنید. این کار به سرور خارجی شما اجازه میده تا بدون نیاز به رمز عبور، به سرور ایران متصل بشه:

```bash
echo "Your SSH Public Key" >> ~/.ssh/authorized_keys
```

**نکته**: به جای "Your SSH Public Key" باید کلید عمومی که در مرحله قبل کپی کردید رو قرار بدید.

### 📞 تست اتصال SSH (از سرور خارجی به سرور ایران)

برای اطمینان از اینکه اتصال SSH به درستی برقرار شده، از سرور خارجی به سرور ایران تست کنید:

```bash
ssh root@IranIP -p port
```

**توضیحات**:

  * توضیح : `IranIP`: آدرس IP سرور ایران شماست.
  * توضیح : `port`: پورت SSH سرور ایران شماست (معمولاً 22).

### ⚙️ نصب wstunnel (در هر دو سرور)

حالا `wstunnel` رو روی **هر دو** سرور خارجی و ایران نصب کنید:

```bash
wget -O - https://github.com/erebe/wstunnel/releases/download/v10.4.4/wstunnel_10.4.4_linux_amd64.tar.gz | sudo tar -xz -C /usr/local/bin/ wstunnel
sudo chmod +x /usr/local/bin/wstunnel
```

-----

## 🌎 تنظیمات در سرور خارجی

در سرور خارجی، دو مرحله برای راه‌اندازی تونل دارید:

### مرحله 1: ایجاد تونل SSH معکوس

این دستور یک تونل SSH معکوس ایجاد می‌کنه. به این معنی که پورت 8081 سرور **خارجی** به پورت 8081 سرور **ایران** فوروارد میشه. 🚪

```bash
ssh -p SSH_PORT -N -R 127.0.0.1:8081:127.0.0.1:8081 root@<IranIP> \
  -o ServerAliveInterval=60 -o ServerAliveCountMax=3 -o ExitOnForwardFailure=yes
```

**توضیحات**:

  * توضیح : `-N`: به این معنی که هیچ دستوری اجرا نمی‌شود. فقط تونل ایجاد می‌شود.
  * توضیح : `-R 127.0.0.1:8081:127.0.0.1:8081`: پورت لوکال 8081 سرور ایران را به پورت لوکال 8081 سرور خارجی مپ می‌کند.
  * توضیح : `IranIP`: آدرس IP سرور ایران.
  * توضیح : `ServerAliveInterval` و `ServerAliveCountMax`: برای جلوگیری از قطع شدن اتصال SSH استفاده می‌شوند.
  * توضیح : `ExitOnForwardFailure=yes`: در صورت عدم موفقیت در ایجاد تونل، SSH قطع می‌شود.
  * توضیح : بجای `SSH_PORT` پورت `SSH` سرور ایران قرار دهید.

### مرحله 2: راه‌اندازی سرور wstunnel

حالا `wstunnel` رو به عنوان سرور در پورت 8081 (که توسط SSH فوروارد شده) و با محدودیت دسترسی به پورت 8080 **کانفیگ Xray شما** راه‌اندازی کنید. 🔄

```bash
wstunnel server --restrict-to 127.0.0.1:8080 ws://127.0.0.1:8081
```

**توضیحات**:

  * توضیح : `--restrict-to 127.0.0.1:8080`: `wstunnel` تنها به پورت 8080 (پورت کانفیگ Xray شما) دسترسی خواهد داشت.
  * توضیح : `ws://127.0.0.1:8081`: `wstunnel` بر روی پورت 8081 سرور خارجی گوش میده.

-----

## 🇮🇷 تنظیمات در سرور ایران

در سرور ایران، `wstunnel` رو به عنوان کلاینت راه‌اندازی می‌کنیم تا به سرور `wstunnel` در سرور خارجی متصل بشه:

```bash
wstunnel client -L tcp://0.0.0.0:8080:127.0.0.1:8080 ws://127.0.0.1:8081
```

**توضیحات**:

  * توضیح : `-L tcp://0.0.0.0:8080:127.0.0.1:8080`: این بخش به `wstunnel` میگه که ترافیک ورودی به پورت **8080 سرور ایران** رو به پورت **8080 سرور خارجی** (یعنی پورت Xray شما) تونل کنه.
      * توضیح : `0.0.0.0:8080`: این یعنی `wstunnel` روی تمام اینترفیس‌های سرور ایران به پورت 8080 گوش میده و آماده دریافت اتصالات از کلاینت‌ها هست.
      * توضیح : `127.0.0.1:8080`: این آدرس مقصد در سرور خارجی هستش که ترافیک از طریق تونل SSH به اونجا هدایت میشه.
  * توضیح : `ws://127.0.0.1:8081`: `wstunnel` کلاینت به سرور `wstunnel` در سرور خارجی (از طریق تونل SSH که روی پورت 8081 در ایران گوش میده) متصل میشه.

**خلاصه پورت‌ها و جایگذاری IranIP**:

  * توضیح : **`IranIP`**: آدرس IP عمومی سرور شما در ایران هست. در دستور SSH ازش استفاده میشه.
  * توضیح : **پورت 8081 (در هر دو سرور)**: این پورت برای ارتباط داخلی `wstunnel` از طریق تونل SSH استفاده میشه. این پورت مستقیماً از بیرون قابل دسترسی نیست.
  * توضیح : **پورت 8080 (در سرور خارجی)**: این پورت **داخلی** سرور خارجی شماست که سرویس Xray شما روی اون در حال اجراست و `wstunnel` بهش دسترسی پیدا می‌کنه.
  * توضیح : **پورت 8080 (در سرور ایران)**: این پورت **عمومی** هست که `wstunnel` در سرور ایران روی اون گوش میده و ترافیک رو از کاربران دریافت می‌کنه و به سمت سرور خارجی ارسال می‌کنه.

-----

### 💡 پیشنهاد: مدیریت با Systemd

برای اینکه این تونل‌ها پس از راه‌اندازی مجدد سرورها به صورت خودکار شروع به کار کنند و پایدارتر باشن، پیشنهاد میشه از **Systemd** استفاده کنید. با Systemd میتونید سرویس‌های مجزایی برای هر بخش (SSH تونل و `wstunnel` سرور در سرور خارجی، و `wstunnel` کلاینت در سرور ایران) ایجاد کنید.

این کار به شما اجازه میده که وضعیت سرویس‌ها رو مانیتور کنید و در صورت نیاز به راحتی اون‌ها رو مدیریت کنید (شروع، توقف، ریستارت).
